<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¥ºå­é¦…è°ƒé…æ¸¸æˆ - é«˜çº§äº¤äº’ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary-color: #d32f2f;
            --secondary-color: #ff9800;
            --success-color: #4caf50;
            --info-color: #2196f3;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --light-bg: #f8f3e9;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-light: #666666;
            --border-color: #e0e0e0;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 8px 25px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f8f3e9"/><path d="M0,50 Q25,40 50,50 T100,50 L100,100 L0,100 Z" fill="%23f0e6d2" opacity="0.3"/></svg>');
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, var(--primary-color), #b71c1c);
            border-radius: var(--border-radius);
            color: white;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="white" opacity="0.05"/></svg>');
            background-size: 150px 150px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            position: relative;
        }
        
        /* è§’è‰²é€‰æ‹©å™¨ */
        .role-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .role-btn {
            padding: 16px 35px;
            font-size: 1.2rem;
            background-color: white;
            color: var(--primary-color);
            border: 3px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-light);
        }
        
        .role-btn:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            background-color: var(--primary-color);
            color: white;
        }
        
        .role-btn.active {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .role-btn .icon {
            font-size: 1.5rem;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        
        .card:hover {
            box-shadow: var(--shadow-medium);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .card-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* å­¦ç”Ÿç«¯æ ·å¼ */
        #student-view {
            display: block;
        }
        
        .student-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 768px) {
            .student-setup {
                grid-template-columns: 1fr;
            }
        }
        
        .setup-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: bold;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group label .icon {
            color: var(--primary-color);
        }
        
        .form-control {
            padding: 14px;
            font-size: 1.1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }
        
        /* æ¸¸æˆåŒºåŸŸ */
        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1024px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }
        
        /* åŸæ–™é€‰æ‹© */
        .ingredients-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .ingredients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            flex: 1;
        }
        
        .ingredient-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .ingredient-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-color);
        }
        
        .ingredient-card.selected {
            background-color: #ffebee;
            border-color: var(--primary-color);
            transform: translateY(-3px);
        }
        
        .ingredient-card.selected::after {
            content: "âœ“";
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .ingredient-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            border-radius: 50%;
            background-color: #f8f8f8;
            transition: var(--transition);
        }
        
        .ingredient-card:hover .ingredient-icon {
            transform: scale(1.1);
        }
        
        .ingredient-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .ingredient-pinyin {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .ingredient-desc {
            font-size: 0.8rem;
            color: #888;
        }
        
        /* å·²é€‰æ‹©åŸæ–™ */
        .selected-ingredients-container {
            margin-top: 20px;
        }
        
        .selected-ingredients {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .selected-tag {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background-color: #e3f2fd;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid #bbdefb;
        }
        
        .selected-tag .remove-btn {
            margin-left: 8px;
            cursor: pointer;
            color: var(--danger-color);
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1;
        }
        
        /* å¥å­æ„å»º */
        .sentence-builder {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .builder-section {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .word-item {
            padding: 10px 15px;
            background-color: white;
            border-radius: 8px;
            cursor: grab;
            border: 2px dashed var(--border-color);
            transition: var(--transition);
            user-select: none;
            font-size: 1.1rem;
        }
        
        .word-item:hover {
            border-color: var(--primary-color);
            background-color: #fff9f9;
            transform: translateY(-2px);
        }
        
        .sentence-area {
            min-height: 100px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            background-color: white;
            margin-bottom: 15px;
        }
        
        .sentence-word {
            padding: 8px 15px;
            background-color: #e8f5e9;
            border-radius: 6px;
            border: 1px solid #c8e6c9;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .sentence-word:hover {
            background-color: #ffebee;
            border-color: #ffcdd2;
        }
        
        .sentence-word.placeholder {
            background-color: transparent;
            border: 2px dashed #ccc;
            color: #999;
            min-width: 80px;
            text-align: center;
        }
        
        .sentence-actions {
            display: flex;
            gap: 15px;
        }
        
        /* ç»“æœåŒºåŸŸ */
        .result-area {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .bowl-container {
            text-align: center;
            margin-top: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #bowl {
            width: 220px;
            height: 220px;
            background: radial-gradient(circle at 30% 30%, #fff8e1, #ffecb3);
            border-radius: 50%;
            margin: 0 auto 25px;
            position: relative;
            border: 15px solid #ffd54f;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }
        
        #bowl.filled {
            transform: scale(1.05);
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.1), 0 15px 30px rgba(0, 0, 0, 0.2);
        }
        
        .ingredient-in-bowl {
            position: absolute;
            border-radius: 50%;
            opacity: 0;
            animation: dropIn 0.8s forwards;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        @keyframes dropIn {
            0% { 
                opacity: 0; 
                transform: translateY(-100px) scale(0.5);
            }
            70% { 
                opacity: 1; 
                transform: translateY(10px) scale(1.1);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        .result-text {
            font-size: 1.3rem;
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            border-left: 5px solid var(--primary-color);
            box-shadow: var(--shadow-light);
        }
        
        /* è¿›åº¦å’Œå¾—åˆ† */
        .progress-section {
            margin-top: 25px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 6px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-light);
            border-top: 4px solid var(--info-color);
        }
        
        .stat-card.score {
            border-top-color: var(--success-color);
        }
        
        .stat-card.accuracy {
            border-top-color: var(--warning-color);
        }
        
        .stat-card.attempts {
            border-top-color: var(--danger-color);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        /* æ•™å¸ˆç«¯æ ·å¼ */
        #teacher-view {
            display: none;
        }
        
        .teacher-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .teacher-dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 1200px) {
            .teacher-dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .class-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .overview-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: var(--shadow-light);
            border-top: 5px solid var(--info-color);
        }
        
        .overview-card.total {
            border-top-color: var(--info-color);
        }
        
        .overview-card.active {
            border-top-color: var(--success-color);
        }
        
        .overview-card.completed {
            border-top-color: var(--warning-color);
        }
        
        .overview-card.average {
            border-top-color: var(--primary-color);
        }
        
        .overview-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .overview-label {
            font-size: 1rem;
            color: var(--text-light);
        }
        
        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .student-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            border-left: 5px solid var(--info-color);
            transition: var(--transition);
        }
        
        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }
        
        .student-card.completed {
            border-left-color: var(--success-color);
        }
        
        .student-card.active {
            border-left-color: var(--warning-color);
        }
        
        .student-card.inactive {
            border-left-color: var(--text-light);
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .student-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-active {
            background-color: #e8f5e9;
            color: var(--success-color);
        }
        
        .status-completed {
            background-color: #fff3e0;
            color: var(--warning-color);
        }
        
        .status-inactive {
            background-color: #f5f5f5;
            color: var(--text-light);
        }
        
        .student-progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .student-progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
        }
        
        .student-details {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .student-ingredients {
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .student-ingredients ul {
            padding-left: 20px;
            margin-top: 5px;
        }
        
        .student-ingredients li {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            gap: 10px;
            box-shadow: var(--shadow-light);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #b71c1c;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #f57c00;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #388e3c;
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }
        
        .btn-info:hover {
            background-color: #1976d2;
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .btn-lg {
            padding: 16px 35px;
            font-size: 1.2rem;
        }
        
        /* åé¦ˆæ¶ˆæ¯ */
        .feedback {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.5s ease;
            box-shadow: var(--shadow-light);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .feedback.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 5px solid #4caf50;
        }
        
        .feedback.error {
            background-color: #ffebee;
            color: #c62828;
            border-left: 5px solid #f44336;
        }
        
        .feedback.info {
            background-color: #e3f2fd;
            color: #1565c0;
            border-left: 5px solid #2196f3;
        }
        
        .feedback.warning {
            background-color: #fff3e0;
            color: #ef6c00;
            border-left: 5px solid #ff9800;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .modal-close:hover {
            color: var(--primary-color);
            transform: rotate(90deg);
        }
        
        /* å·¥å…·æç¤º */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            font-weight: normal;
            box-shadow: var(--shadow-medium);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .game-area, .teacher-dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .student-list {
                grid-template-columns: 1fr;
            }
            
            .student-setup {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .ingredients-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        
        /* åŠ¨ç”» */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* è¯­éŸ³æŒ‰é’® */
        .voice-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--info-color);
            transition: var(--transition);
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-btn:hover {
            background-color: #e3f2fd;
            transform: scale(1.1);
        }
        
        /* æ—¶é—´æˆ³ */
        .timestamp {
            font-size: 0.8rem;
            color: var(--text-light);
            font-style: italic;
        }
        
        /* è¿æ¥çŠ¶æ€ */
        .connection-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-connected {
            background-color: #e8f5e9;
            color: var(--success-color);
        }
        
        .status-disconnected {
            background-color: #ffebee;
            color: var(--danger-color);
        }
        
        .status-connecting {
            background-color: #fff3e0;
            color: var(--warning-color);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¥Ÿ é¥ºå­é¦…è°ƒé…æ¸¸æˆ</h1>
            <p class="subtitle">å­¦ä¹ "æŠŠ"å­—å¥ï¼Œè°ƒé…ç¾å‘³é¥ºå­é¦…</p>
            <div class="connection-status status-connected" id="global-connection-status">
                <span class="icon">ğŸ”—</span> å·²è¿æ¥
            </div>
        </header>
        
        <div class="role-selector">
            <button class="role-btn active" id="student-btn">
                <span class="icon">ğŸ‘¨â€ğŸ“</span> å­¦ç”Ÿç«¯
            </button>
            <button class="role-btn" id="teacher-btn">
                <span class="icon">ğŸ‘¨â€ğŸ«</span> æ•™å¸ˆç«¯
            </button>
        </div>
        
        <!-- å­¦ç”Ÿç«¯ -->
        <div id="student-view">
            <!-- å­¦ç”Ÿè®¾ç½® -->
            <div class="card" id="student-setup-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ‘¤</span> å­¦ç”Ÿä¿¡æ¯è®¾ç½®
                    </h2>
                </div>
                <div class="student-setup">
                    <div class="setup-form">
                        <div class="form-group">
                            <label for="student-name-input">
                                <span class="icon">ğŸ“</span> å§“å
                            </label>
                            <input type="text" id="student-name-input" class="form-control" placeholder="è¯·è¾“å…¥ä½ çš„å§“å">
                            <small>è¯·ä½¿ç”¨çœŸå®å§“åï¼Œæ–¹ä¾¿è€å¸ˆæŸ¥çœ‹</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="class-code-input">
                                <span class="icon">ğŸ«</span> ç­çº§ä»£ç 
                            </label>
                            <input type="text" id="class-code-input" class="form-control" placeholder="è¯·è¾“å…¥è€å¸ˆæä¾›çš„ç­çº§ä»£ç ">
                            <small>å¦‚æœä¸çŸ¥é“ä»£ç ï¼Œè¯·è¯¢é—®è€å¸ˆ</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="student-id-input">
                                <span class="icon">ğŸ†”</span> å­¦å· (å¯é€‰)
                            </label>
                            <input type="text" id="student-id-input" class="form-control" placeholder="è¯·è¾“å…¥å­¦å· (å¯é€‰)">
                        </div>
                        
                        <button class="btn btn-primary btn-lg" id="join-class-btn">
                            <span class="icon">ğŸšª</span> åŠ å…¥ç­çº§
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">
                            <span class="icon">â„¹ï¸</span> æ¸¸æˆè¯´æ˜
                        </h3>
                        <ol style="padding-left: 20px; margin-top: 15px;">
                            <li>è¾“å…¥å§“åå’Œç­çº§ä»£ç åŠ å…¥è¯¾å ‚</li>
                            <li>é€‰æ‹©1-3ç§é¥ºå­é¦…åŸæ–™</li>
                            <li>ä½¿ç”¨æä¾›çš„è¯è¯­æ„å»ºæ­£ç¡®çš„"æŠŠ"å­—å¥</li>
                            <li>ç‚¹å‡»éªŒè¯æŒ‰é’®æ£€æŸ¥å¥å­æ˜¯å¦æ­£ç¡®</li>
                            <li>æ­£ç¡®çš„å¥å­ä¼šå°†åŸæ–™åŠ å…¥ç¢—ä¸­</li>
                            <li>ç›®æ ‡æ˜¯ä½¿ç”¨æ‰€æœ‰8ç§åŸæ–™å®Œæˆé¥ºå­é¦…è°ƒé…</li>
                            <li>æ•™å¸ˆå¯ä»¥å®æ—¶æŸ¥çœ‹ä½ çš„è¿›åº¦</li>
                        </ol>
                        <div class="feedback info" style="margin-top: 20px;">
                            <span class="icon">ğŸ’¡</span> æç¤ºï¼šæ‰€æœ‰è¯æ±‡éƒ½åœ¨HSK4çº§èŒƒå›´å†…
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ¸¸æˆç•Œé¢ (åˆå§‹éšè—) -->
            <div id="game-interface" style="display: none;">
                <div class="game-area">
                    <!-- å·¦ä¾§ï¼šåŸæ–™é€‰æ‹©å’Œå¥å­æ„å»º -->
                    <div class="ingredients-section card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span class="icon">ğŸ¥¬</span> é€‰æ‹©é¥ºå­åŸæ–™
                            </h2>
                            <div class="connection-status status-connected" id="student-status">
                                <span class="icon">ğŸ“¡</span> åŒæ­¥ä¸­
                            </div>
                        </div>
                        
                        <div class="ingredients-grid" id="ingredients-container">
                            <!-- åŸæ–™å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <div class="selected-ingredients-container">
                            <h3 class="section-title">
                                <span class="icon">âœ…</span> å·²é€‰æ‹©çš„åŸæ–™
                            </h3>
                            <div class="selected-ingredients" id="selected-ingredients">
                                <div class="selected-tag placeholder">
                                    è¯·ä»ä¸Šæ–¹é€‰æ‹©1-3ç§åŸæ–™
                                </div>
                            </div>
                        </div>
                        
                        <div class="sentence-builder card" style="margin-top: 20px;">
                            <div class="card-header">
                                <h2 class="card-title">
                                    <span class="icon">ğŸ“</span> æ„å»º"æŠŠ"å­—å¥
                                </h2>
                                <button class="btn btn-outline btn-sm" id="voice-btn">
                                    <span class="icon">ğŸ”Š</span> æœ—è¯»
                                </button>
                            </div>
                            
                            <div class="builder-section">
                                <h3 class="section-title">
                                    <span class="icon">ğŸ§±</span> è¯è¯­åº“
                                </h3>
                                <div class="word-bank" id="word-bank">
                                    <!-- è¯è¯­å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                                
                                <h3 class="section-title">
                                    <span class="icon">âœ¨</span> å¥å­æ„å»ºåŒº
                                </h3>
                                <div class="sentence-area" id="sentence-area">
                                    <div class="sentence-word placeholder">
                                        ä¸»è¯­
                                    </div>
                                    <div class="sentence-word placeholder">
                                        æŠŠ
                                    </div>
                                    <div class="sentence-word placeholder">
                                        å®¾è¯­
                                    </div>
                                    <div class="sentence-word placeholder">
                                        åŠ¨è¯
                                    </div>
                                    <div class="sentence-word placeholder">
                                        å…¶ä»–æˆåˆ†
                                    </div>
                                </div>
                                
                                <div class="sentence-actions">
                                    <button class="btn btn-primary" id="validate-btn">
                                        <span class="icon">âœ“</span> éªŒè¯å¥å­
                                    </button>
                                    <button class="btn btn-outline" id="clear-sentence-btn">
                                        <span class="icon">ğŸ—‘ï¸</span> æ¸…ç©º
                                    </button>
                                    <button class="btn btn-outline" id="hint-btn">
                                        <span class="icon">ğŸ’¡</span> æç¤º
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šç»“æœå±•ç¤ºå’Œè¿›åº¦ -->
                    <div class="result-area card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span class="icon">ğŸ¥£</span> é¥ºå­é¦…è°ƒé…ç»“æœ
                            </h2>
                            <button class="btn btn-secondary btn-sm" id="add-ingredient-btn" disabled>
                                <span class="icon">â•</span> æ·»åŠ åˆ°ç¢—ä¸­
                            </button>
                        </div>
                        
                        <div class="bowl-container">
                            <div id="bowl"></div>
                            <div class="result-text" id="result-text">
                                ç¢—æ˜¯ç©ºçš„ï¼Œå¼€å§‹æ·»åŠ åŸæ–™è°ƒé…é¥ºå­é¦…å§ï¼
                            </div>
                        </div>
                        
                        <div class="progress-section">
                            <h3 class="section-title">
                                <span class="icon">ğŸ“Š</span> è¿›åº¦å’Œå¾—åˆ†
                            </h3>
                            <div class="progress-info">
                                <span>é¦…æ–™è°ƒé…è¿›åº¦</span>
                                <span id="progress-text">0/8</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            
                            <div class="stats-grid">
                                <div class="stat-card score">
                                    <div class="stat-value" id="score-value">0</div>
                                    <div class="stat-label">å¾—åˆ†</div>
                                </div>
                                <div class="stat-card accuracy">
                                    <div class="stat-value" id="accuracy-value">0%</div>
                                    <div class="stat-label">å‡†ç¡®ç‡</div>
                                </div>
                                <div class="stat-card attempts">
                                    <div class="stat-value" id="attempts-value">0</div>
                                    <div class="stat-label">å°è¯•æ¬¡æ•°</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 20px;">
                            <h3 class="card-title">
                                <span class="icon">ğŸ“‹</span> å·²æ·»åŠ çš„åŸæ–™
                            </h3>
                            <div id="added-ingredients-list">
                                <p style="color: var(--text-light); text-align: center; padding: 20px;">
                                    è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•åŸæ–™
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="feedback" id="game-feedback" style="display: none;"></div>
            </div>
        </div>
        
        <!-- æ•™å¸ˆç«¯ -->
        <div id="teacher-view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="icon">ğŸ‘¨â€ğŸ«</span> æ•™å¸ˆæ§åˆ¶é¢æ¿
                    </h2>
                    <div class="connection-status status-connected" id="teacher-status">
                        <span class="icon">ğŸ“¡</span> å®æ—¶åŒæ­¥
                    </div>
                </div>
                
                <div class="teacher-controls">
                    <div class="form-group" style="flex: 1;">
                        <label for="teacher-class-code-input">
                            <span class="icon">ğŸ«</span> ç­çº§ä»£ç 
                        </label>
                        <input type="text" id="teacher-class-code-input" class="form-control" placeholder="è¾“å…¥æˆ–ç”Ÿæˆç­çº§ä»£ç ">
                    </div>
                    
                    <button class="btn btn-primary" id="create-class-btn">
                        <span class="icon">â•</span> åˆ›å»ºæ–°ç­çº§
                    </button>
                    <button class="btn btn-info" id="load-class-btn">
                        <span class="icon">ğŸ“‚</span> åŠ è½½ç­çº§
                    </button>
                    <button class="btn btn-secondary" id="export-data-btn">
                        <span class="icon">ğŸ“¤</span> å¯¼å‡ºæ•°æ®
                    </button>
                </div>
                
                <div id="class-info" style="display: none;">
                    <div class="class-overview">
                        <div class="overview-card total">
                            <div class="overview-value" id="total-students">0</div>
                            <div class="overview-label">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div class="overview-card active">
                            <div class="overview-value" id="active-students">0</div>
                            <div class="overview-label">æ´»è·ƒå­¦ç”Ÿ</div>
                        </div>
                        <div class="overview-card completed">
                            <div class="overview-value" id="completed-students">0</div>
                            <div class="overview-label">å·²å®Œæˆ</div>
                        </div>
                        <div class="overview-card average">
                            <div class="overview-value" id="average-score">0</div>
                            <div class="overview-label">å¹³å‡å¾—åˆ†</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="icon">ğŸ‘¥</span> å­¦ç”Ÿåˆ—è¡¨
                            </h3>
                            <div>
                                <button class="btn btn-outline btn-sm" id="refresh-students-btn">
                                    <span class="icon">ğŸ”„</span> åˆ·æ–°
                                </button>
                                <button class="btn btn-outline btn-sm" id="sort-students-btn">
                                    <span class="icon">ğŸ“Š</span> æŒ‰å¾—åˆ†æ’åº
                                </button>
                            </div>
                        </div>
                        
                        <div class="student-list" id="student-list-container">
                            <div class="card" style="text-align: center; padding: 40px;">
                                <div class="loader"></div>
                                <p style="margin-top: 15px; color: var(--text-light);">æ­£åœ¨åŠ è½½å­¦ç”Ÿæ•°æ®...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¯­æ³•æç¤ºæ¨¡æ€æ¡† -->
        <div class="modal" id="grammar-hint-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <span class="icon">ğŸ’¡</span> "æŠŠ"å­—å¥è¯­æ³•æç¤º
                    </h3>
                    <button class="modal-close" id="close-grammar-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <h4>ä½ç§»æŠŠå­—å¥ç»“æ„ï¼š</h4>
                    <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>ä¸»è¯­ + æŠŠ + å®¾è¯­ + åŠ¨è¯ + å…¶ä»–æˆåˆ†</strong>
                    </div>
                    
                    <h4>å¸¸ç”¨ç»“æ„ç¤ºä¾‹ï¼š</h4>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li><strong>ä¸»è¯­ + æŠŠ + å®¾è¯­ + åŠ¨è¯ + åˆ° + åœ°ç‚¹</strong><br>ä¾‹å¦‚ï¼šæˆ‘æŠŠçŒªè‚‰æ”¾åˆ°ç¢—é‡Œã€‚</li>
                        <li><strong>ä¸»è¯­ + æŠŠ + å®¾è¯­ + åŠ¨è¯ + è¿› + åœ°ç‚¹</strong><br>ä¾‹å¦‚ï¼šå¦ˆå¦ˆæŠŠé¸¡è›‹æ‰“è¿›ç¢—é‡Œã€‚</li>
                        <li><strong>ä¸»è¯­ + æŠŠ + å®¾è¯­ + åŠ¨è¯ + åœ¨ + åœ°ç‚¹</strong><br>ä¾‹å¦‚ï¼šä»–æŠŠè‘±æ”¾åœ¨æ¡Œå­ä¸Šã€‚</li>
                    </ul>
                    
                    <h4>å¸¸ç”¨è¯æ±‡ï¼š</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;">
                        <div style="background-color: #e8f5e9; padding: 10px; border-radius: 6px;">
                            <strong>ä¸»è¯­ï¼š</strong>æˆ‘ã€ä»–ã€å¥¹ã€å¦ˆå¦ˆã€çˆ¸çˆ¸ã€æˆ‘ä»¬ã€å¨å¸ˆ
                        </div>
                        <div style="background-color: #e3f2fd; padding: 10px; border-radius: 6px;">
                            <strong>åŠ¨è¯ï¼š</strong>æ”¾ã€åŠ ã€å€’ã€åˆ‡ã€æ‰“ã€æ…æ‹Œã€æ··åˆ
                        </div>
                        <div style="background-color: #f3e5f5; padding: 10px; border-radius: 6px;">
                            <strong>åœ°ç‚¹ï¼š</strong>ç¢—é‡Œã€ç›†ä¸­ã€é”…é‡Œã€æ¡Œå­ä¸Šã€ä¸­é—´ã€ä¸€èµ·
                        </div>
                        <div style="background-color: #fff3e0; padding: 10px; border-radius: 6px;">
                            <strong>å…¶ä»–ï¼š</strong>å…ˆã€ç„¶åã€å†ã€ä¸€èµ·ã€æ…¢æ…¢ã€è½»è½»åœ°
                        </div>
                    </div>
                    
                    <div class="feedback info" style="margin-top: 20px;">
                        <span class="icon">ğŸ’¡</span> æç¤ºï¼šç¡®ä¿å¥å­ä¸­æœ‰æ˜ç¡®çš„ä½ç§»åŠ¨ä½œå’Œç›®çš„åœ°
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æˆåŠŸæ¨¡æ€æ¡† -->
        <div class="modal" id="success-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <span class="icon">ğŸ‰</span> æ­å–œï¼
                    </h3>
                    <button class="modal-close" id="close-success-modal">&times;</button>
                </div>
                <div class="modal-body" style="text-align: center; padding: 30px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ¥Ÿ</div>
                    <h2 style="color: var(--success-color); margin-bottom: 15px;">é¥ºå­é¦…è°ƒé…å®Œæˆï¼</h2>
                    <p style="font-size: 1.2rem; margin-bottom: 25px;">
                        ä½ å·²ç»æˆåŠŸè°ƒé…äº†ç¾å‘³çš„é¥ºå­é¦…ï¼Œä½¿ç”¨äº†æ‰€æœ‰8ç§åŸæ–™ï¼
                    </p>
                    <div style="background-color: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <h4>ä½ çš„æˆç»©ï¼š</h4>
                        <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                            <div>
                                <div class="stat-value" id="final-score">0</div>
                                <div class="stat-label">æœ€ç»ˆå¾—åˆ†</div>
                            </div>
                            <div>
                                <div class="stat-value" id="final-accuracy">0%</div>
                                <div class="stat-label">å‡†ç¡®ç‡</div>
                            </div>
                            <div>
                                <div class="stat-value" id="final-time">0s</div>
                                <div class="stat-label">ç”¨æ—¶</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-lg" id="share-result-btn">
                        <span class="icon">ğŸ“¤</span> åˆ†äº«ç»“æœ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ ¸å¿ƒæ•°æ®
        const gameState = {
            // å­¦ç”Ÿä¿¡æ¯
            student: {
                name: '',
                id: '',
                classCode: '',
                connected: false
            },
            
            // æ¸¸æˆçŠ¶æ€
            selectedIngredients: [],
            addedIngredients: [],
            currentSentence: [],
            score: 0,
            correctCount: 0,
            totalAttempts: 0,
            startTime: null,
            gameActive: false,
            
            // æ•™å¸ˆçŠ¶æ€
            teacher: {
                classCode: '',
                classData: null
            }
        };
        
        // åŸæ–™æ•°æ®ï¼ˆHSK4çº§è¯æ±‡ï¼‰
        const ingredients = [
            { id: 1, name: "çŒªè‚‰", pinyin: "zhÅ« rÃ²u", emoji: "ğŸ¥©", desc: "ä¸»è¦è‚‰ç±»åŸæ–™", color: "#ffcdd2", category: "è‚‰ç±»" },
            { id: 2, name: "ç™½èœ", pinyin: "bÃ¡i cÃ i", emoji: "ğŸ¥¬", desc: "ç»å…¸è”¬èœåŸæ–™", color: "#c8e6c9", category: "è”¬èœ" },
            { id: 3, name: "é¸¡è›‹", pinyin: "jÄ« dÃ n", emoji: "ğŸ¥š", desc: "å¢åŠ é¦…æ–™å£æ„Ÿ", color: "#fff9c4", category: "è›‹ç±»" },
            { id: 4, name: "è‘±", pinyin: "cÅng", emoji: "ğŸ§…", desc: "è°ƒå‘³å¿…å¤‡", color: "#dcedc8", category: "è°ƒæ–™" },
            { id: 5, name: "ç›", pinyin: "yÃ¡n", emoji: "ğŸ§‚", desc: "è°ƒå‘³", color: "#f5f5f5", category: "è°ƒæ–™" },
            { id: 6, name: "æ²¹", pinyin: "yÃ³u", emoji: "ğŸ«™", desc: "å¢åŠ é¦™å‘³", color: "#ffcc80", category: "è°ƒæ–™" },
            { id: 7, name: "å§œ", pinyin: "jiÄng", emoji: "ğŸ§„", desc: "å»è…¥è°ƒå‘³", color: "#ffecb3", category: "è°ƒæ–™" },
            { id: 8, name: "æ°´", pinyin: "shuÇ", emoji: "ğŸ’§", desc: "è°ƒèŠ‚æ¹¿åº¦", color: "#bbdefb", category: "æ¶²ä½“" }
        ];
        
        // å¥å­æ„å»ºè¯åº“
        const wordBank = {
            subjects: ["æˆ‘", "å¦ˆå¦ˆ", "çˆ¸çˆ¸", "ä»–", "å¥¹", "æˆ‘ä»¬", "å¨å¸ˆ", "è€å¸ˆ", "å§å§", "å“¥å“¥"],
            ba: ["æŠŠ"],
            verbs: ["æ”¾", "åŠ ", "å€’", "åˆ‡", "æ‰“", "æ…æ‹Œ", "æ··åˆ", "æ”¾å…¥", "åŠ åˆ°", "å€’è¿›"],
            prepositions: ["åˆ°", "è¿›", "åœ¨", "ç»™"],
            locations: ["ç¢—é‡Œ", "ç›†ä¸­", "é”…é‡Œ", "æ¡Œå­ä¸Š", "ä¸­é—´", "ä¸€èµ·", "é¦…æ–™é‡Œ", "å®¹å™¨å†…"],
            modifiers: ["å…ˆ", "ç„¶å", "å†", "ä¸€èµ·", "æ…¢æ…¢", "è½»è½»åœ°", "ä»”ç»†åœ°", "å¿«é€Ÿ"],
            connectors: ["å’Œ", "è·Ÿ", "ä¸"]
        };
        
        // æ­£ç¡®çš„å¥å­ç»“æ„æ¨¡æ¿
        const correctPatterns = [
            "subject ba object verb preposition location",
            "subject ba object verb location",
            "subject modifier ba object verb preposition location",
            "subject ba object1 connector object2 verb preposition location"
        ];
        
        // DOMå…ƒç´ 
        const elements = {
            // è§’è‰²åˆ‡æ¢
            studentBtn: document.getElementById('student-btn'),
            teacherBtn: document.getElementById('teacher-btn'),
            studentView: document.getElementById('student-view'),
            teacherView: document.getElementById('teacher-view'),
            
            // å­¦ç”Ÿè®¾ç½®
            studentNameInput: document.getElementById('student-name-input'),
            classCodeInput: document.getElementById('class-code-input'),
            studentIdInput: document.getElementById('student-id-input'),
            joinClassBtn: document.getElementById('join-class-btn'),
            studentSetupCard: document.getElementById('student-setup-card'),
            gameInterface: document.getElementById('game-interface'),
            
            // æ¸¸æˆç•Œé¢
            ingredientsContainer: document.getElementById('ingredients-container'),
            selectedIngredients: document.getElementById('selected-ingredients'),
            wordBank: document.getElementById('word-bank'),
            sentenceArea: document.getElementById('sentence-area'),
            validateBtn: document.getElementById('validate-btn'),
            clearSentenceBtn: document.getElementById('clear-sentence-btn'),
            hintBtn: document.getElementById('hint-btn'),
            addIngredientBtn: document.getElementById('add-ingredient-btn'),
            voiceBtn: document.getElementById('voice-btn'),
            
            // ç»“æœåŒºåŸŸ
            bowl: document.getElementById('bowl'),
            resultText: document.getElementById('result-text'),
            progressText: document.getElementById('progress-text'),
            progressFill: document.getElementById('progress-fill'),
            scoreValue: document.getElementById('score-value'),
            accuracyValue: document.getElementById('accuracy-value'),
            attemptsValue: document.getElementById('attempts-value'),
            addedIngredientsList: document.getElementById('added-ingredients-list'),
            gameFeedback: document.getElementById('game-feedback'),
            
            // æ•™å¸ˆç•Œé¢
            teacherClassCodeInput: document.getElementById('teacher-class-code-input'),
            createClassBtn: document.getElementById('create-class-btn'),
            loadClassBtn: document.getElementById('load-class-btn'),
            exportDataBtn: document.getElementById('export-data-btn'),
            classInfo: document.getElementById('class-info'),
            totalStudents: document.getElementById('total-students'),
            activeStudents: document.getElementById('active-students'),
            completedStudents: document.getElementById('completed-students'),
            averageScore: document.getElementById('average-score'),
            studentListContainer: document.getElementById('student-list-container'),
            refreshStudentsBtn: document.getElementById('refresh-students-btn'),
            sortStudentsBtn: document.getElementById('sort-students-btn'),
            
            // æ¨¡æ€æ¡†
            grammarHintModal: document.getElementById('grammar-hint-modal'),
            closeGrammarModal: document.getElementById('close-grammar-modal'),
            successModal: document.getElementById('success-modal'),
            closeSuccessModal: document.getElementById('close-success-modal'),
            finalScore: document.getElementById('final-score'),
            finalAccuracy: document.getElementById('final-accuracy'),
            finalTime: document.getElementById('final-time'),
            shareResultBtn: document.getElementById('share-result-btn'),
            
            // çŠ¶æ€æ˜¾ç¤º
            studentStatus: document.getElementById('student-status'),
            teacherStatus: document.getElementById('teacher-status'),
            globalConnectionStatus: document.getElementById('global-connection-status')
        };
        
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            setupEventListeners();
            checkExistingSession();
            updateConnectionStatus();
            
            // æ¨¡æ‹Ÿè¿æ¥çŠ¶æ€
            setInterval(updateConnectionStatus, 3000);
            
            // å¦‚æœæ•™å¸ˆç«¯æœ‰ç­çº§ä»£ç ï¼Œè‡ªåŠ¨åŠ è½½
            const savedClassCode = localStorage.getItem('teacherClassCode');
            if (savedClassCode) {
                elements.teacherClassCodeInput.value = savedClassCode;
            }
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è§’è‰²åˆ‡æ¢
            elements.studentBtn.addEventListener('click', () => switchRole('student'));
            elements.teacherBtn.addEventListener('click', () => switchRole('teacher'));
            
            // å­¦ç”Ÿè®¾ç½®
            elements.joinClassBtn.addEventListener('click', joinClass);
            
            // æ¸¸æˆç•Œé¢
            elements.validateBtn.addEventListener('click', validateSentence);
            elements.clearSentenceBtn.addEventListener('click', clearSentence);
            elements.hintBtn.addEventListener('click', showGrammarHint);
            elements.addIngredientBtn.addEventListener('click', addIngredientsToBowl);
            elements.voiceBtn.addEventListener('click', speakCurrentSentence);
            
            // æ•™å¸ˆç•Œé¢
            elements.createClassBtn.addEventListener('click', createClass);
            elements.loadClassBtn.addEventListener('click', loadClass);
            elements.exportDataBtn.addEventListener('click', exportClassData);
            elements.refreshStudentsBtn.addEventListener('click', loadStudentData);
            elements.sortStudentsBtn.addEventListener('click', sortStudentsByScore);
            
            // æ¨¡æ€æ¡†
            elements.closeGrammarModal.addEventListener('click', () => {
                elements.grammarHintModal.style.display = 'none';
            });
            
            elements.closeSuccessModal.addEventListener('click', () => {
                elements.successModal.style.display = 'none';
            });
            
            elements.shareResultBtn.addEventListener('click', shareResults);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', (e) => {
                if (e.target === elements.grammarHintModal) {
                    elements.grammarHintModal.style.display = 'none';
                }
                if (e.target === elements.successModal) {
                    elements.successModal.style.display = 'none';
                }
            });
            
            // å…è®¸Enteré”®åŠ å…¥ç­çº§
            elements.classCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinClass();
            });
            
            elements.teacherClassCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadClass();
            });
        }
        
        // åˆ‡æ¢è§’è‰²
        function switchRole(role) {
            if (role === 'student') {
                elements.studentView.style.display = 'block';
                elements.teacherView.style.display = 'none';
                elements.studentBtn.classList.add('active');
                elements.teacherBtn.classList.remove('active');
            } else {
                elements.studentView.style.display = 'none';
                elements.teacherView.style.display = 'block';
                elements.teacherBtn.classList.add('active');
                elements.studentBtn.classList.remove('active');
                
                // å¦‚æœæ•™å¸ˆç«¯æœ‰ç­çº§ä»£ç ï¼ŒåŠ è½½ç­çº§æ•°æ®
                if (elements.teacherClassCodeInput.value) {
                    loadClass();
                }
            }
        }
        
        // åŠ å…¥ç­çº§
        function joinClass() {
            const name = elements.studentNameInput.value.trim();
            const classCode = elements.classCodeInput.value.trim();
            const studentId = elements.studentIdInput.value.trim();
            
            if (!name) {
                showFeedback('è¯·è¾“å…¥ä½ çš„å§“å', 'error', 'student');
                return;
            }
            
            if (!classCode) {
                showFeedback('è¯·è¾“å…¥ç­çº§ä»£ç ', 'error', 'student');
                return;
            }
            
            // æ£€æŸ¥ç­çº§æ˜¯å¦å­˜åœ¨
            const classData = localStorage.getItem(`dumpling_class_${classCode}`);
            if (!classData) {
                showFeedback('ç­çº§ä»£ç ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æˆ–è”ç³»è€å¸ˆ', 'error', 'student');
                return;
            }
            
            // ä¿å­˜å­¦ç”Ÿä¿¡æ¯
            gameState.student = {
                name: name,
                id: studentId || `student_${Date.now()}`,
                classCode: classCode,
                connected: true
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('studentInfo', JSON.stringify(gameState.student));
            
            // æ›´æ–°UI
            elements.studentSetupCard.style.display = 'none';
            elements.gameInterface.style.display = 'block';
            
            // åˆå§‹åŒ–æ¸¸æˆ
            initGame();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showFeedback(`æˆåŠŸåŠ å…¥ç­çº§ ${classCode}ï¼`, 'success', 'student');
            
            // æ›´æ–°çŠ¶æ€
            elements.studentStatus.innerHTML = `<span class="icon">ğŸ“¡</span> å·²è¿æ¥: ${classCode}`;
            
            // å¼€å§‹æ¸¸æˆè®¡æ—¶
            gameState.startTime = Date.now();
            gameState.gameActive = true;
            
            // å®šæœŸåŒæ­¥æ•°æ®åˆ°ç­çº§
            startDataSync();
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // æ¸…ç©ºä¹‹å‰çš„çŠ¶æ€
            gameState.selectedIngredients = [];
            gameState.addedIngredients = [];
            gameState.currentSentence = [];
            
            // åˆå§‹åŒ–åŸæ–™é€‰æ‹©
            renderIngredients();
            
            // åˆå§‹åŒ–è¯åº“
            renderWordBank();
            
            // åˆå§‹åŒ–å¥å­æ„å»ºåŒº
            renderSentenceArea();
            
            // æ›´æ–°è¿›åº¦æ˜¾ç¤º
            updateProgressDisplay();
            
            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            updateScoreDisplay();
        }
        
        // æ¸²æŸ“åŸæ–™é€‰æ‹©
        function renderIngredients() {
            elements.ingredientsContainer.innerHTML = '';
            
            ingredients.forEach(ingredient => {
                const ingredientCard = document.createElement('div');
                ingredientCard.className = 'ingredient-card';
                ingredientCard.dataset.id = ingredient.id;
                
                // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
                const isAdded = gameState.addedIngredients.some(item => item.id === ingredient.id);
                if (isAdded) {
                    ingredientCard.classList.add('selected');
                    ingredientCard.style.opacity = '0.6';
                    ingredientCard.style.cursor = 'not-allowed';
                }
                
                ingredientCard.innerHTML = `
                    <div class="ingredient-icon" style="background-color: ${ingredient.color}">
                        ${ingredient.emoji}
                    </div>
                    <div class="ingredient-name">${ingredient.name}</div>
                    <div class="ingredient-pinyin">${ingredient.pinyin}</div>
                    <div class="ingredient-desc">${ingredient.desc}</div>
                `;
                
                if (!isAdded) {
                    ingredientCard.addEventListener('click', () => selectIngredient(ingredient));
                }
                
                elements.ingredientsContainer.appendChild(ingredientCard);
            });
        }
        
        // é€‰æ‹©åŸæ–™
        function selectIngredient(ingredient) {
            // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
            const index = gameState.selectedIngredients.findIndex(item => item.id === ingredient.id);
            
            if (index === -1) {
                // æœ€å¤šé€‰æ‹©3ç§
                if (gameState.selectedIngredients.length >= 3) {
                    showFeedback('æœ€å¤šåªèƒ½é€‰æ‹©3ç§åŸæ–™', 'warning', 'student');
                    return;
                }
                
                // æ·»åŠ åˆ°é€‰æ‹©åˆ—è¡¨
                gameState.selectedIngredients.push(ingredient);
            } else {
                // ä»é€‰æ‹©åˆ—è¡¨ä¸­ç§»é™¤
                gameState.selectedIngredients.splice(index, 1);
            }
            
            // æ›´æ–°é€‰æ‹©æ˜¾ç¤º
            updateSelectedIngredientsDisplay();
            
            // æ›´æ–°è¯åº“ï¼ˆæ ¹æ®é€‰æ‹©çš„åŸæ–™è°ƒæ•´å¯ç”¨è¯æ±‡ï¼‰
            updateWordBank();
            
            // å¦‚æœé€‰æ‹©äº†åŸæ–™ï¼Œå¯ç”¨æ·»åŠ æŒ‰é’®
            elements.addIngredientBtn.disabled = gameState.selectedIngredients.length === 0;
        }
        
        // æ›´æ–°å·²é€‰æ‹©åŸæ–™æ˜¾ç¤º
        function updateSelectedIngredientsDisplay() {
            elements.selectedIngredients.innerHTML = '';
            
            if (gameState.selectedIngredients.length === 0) {
                elements.selectedIngredients.innerHTML = `
                    <div class="selected-tag placeholder">
                        è¯·ä»ä¸Šæ–¹é€‰æ‹©1-3ç§åŸæ–™
                    </div>
                `;
                return;
            }
            
            gameState.selectedIngredients.forEach(ingredient => {
                const tag = document.createElement('div');
                tag.className = 'selected-tag';
                tag.innerHTML = `
                    ${ingredient.emoji} ${ingredient.name}
                    <span class="remove-btn" data-id="${ingredient.id}">Ã—</span>
                `;
                
                // æ·»åŠ ç§»é™¤äº‹ä»¶
                const removeBtn = tag.querySelector('.remove-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = parseInt(e.target.dataset.id);
                    const index = gameState.selectedIngredients.findIndex(item => item.id === id);
                    if (index !== -1) {
                        gameState.selectedIngredients.splice(index, 1);
                        updateSelectedIngredientsDisplay();
                        updateWordBank();
                        elements.addIngredientBtn.disabled = gameState.selectedIngredients.length === 0;
                    }
                });
                
                elements.selectedIngredients.appendChild(tag);
            });
        }
        
        // æ¸²æŸ“è¯åº“
        function renderWordBank() {
            elements.wordBank.innerHTML = '';
            
            // æ·»åŠ ä¸»è¯­
            wordBank.subjects.forEach(subject => {
                const wordItem = createWordItem(subject, 'subject');
                elements.wordBank.appendChild(wordItem);
            });
            
            // æ·»åŠ "æŠŠ"
            const baItem = createWordItem('æŠŠ', 'ba');
            elements.wordBank.appendChild(baItem);
            
            // æ·»åŠ åŠ¨è¯
            wordBank.verbs.forEach(verb => {
                const wordItem = createWordItem(verb, 'verb');
                elements.wordBank.appendChild(wordItem);
            });
            
            // æ·»åŠ ä»‹è¯
            wordBank.prepositions.forEach(preposition => {
                const wordItem = createWordItem(preposition, 'preposition');
                elements.wordBank.appendChild(wordItem);
            });
            
            // æ·»åŠ åœ°ç‚¹
            wordBank.locations.forEach(location => {
                const wordItem = createWordItem(location, 'location');
                elements.wordBank.appendChild(wordItem);
            });
            
            // æ·»åŠ ä¿®é¥°è¯­
            wordBank.modifiers.forEach(modifier => {
                const wordItem = createWordItem(modifier, 'modifier');
                elements.wordBank.appendChild(wordItem);
            });
            
            // æ·»åŠ è¿æ¥è¯
            wordBank.connectors.forEach(connector => {
                const wordItem = createWordItem(connector, 'connector');
                elements.wordBank.appendChild(wordItem);
            });
        }
        
        // åˆ›å»ºè¯è¯­é¡¹
        function createWordItem(text, type) {
            const wordItem = document.createElement('div');
            wordItem.className = 'word-item';
            wordItem.textContent = text;
            wordItem.dataset.type = type;
            wordItem.draggable = true;
            
            // æ·»åŠ æ‹–æ‹½äº‹ä»¶
            wordItem.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', JSON.stringify({ text, type }));
                wordItem.style.opacity = '0.5';
            });
            
            wordItem.addEventListener('dragend', () => {
                wordItem.style.opacity = '1';
            });
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆä½œä¸ºæ‹–æ‹½çš„æ›¿ä»£ï¼‰
            wordItem.addEventListener('click', () => {
                addWordToSentence(text, type);
            });
            
            return wordItem;
        }
        
        // æ›´æ–°è¯åº“ï¼ˆæ ¹æ®é€‰æ‹©çš„åŸæ–™è°ƒæ•´ï¼‰
        function updateWordBank() {
            // å¦‚æœæœ‰é€‰æ‹©åŸæ–™ï¼Œæ·»åŠ å®¾è¯­è¯
            const wordItems = elements.wordBank.querySelectorAll('.word-item');
            wordItems.forEach(item => {
                if (item.dataset.type === 'object') {
                    item.remove();
                }
            });
            
            if (gameState.selectedIngredients.length > 0) {
                // åˆ›å»ºå®¾è¯­è¯
                let objectText = '';
                if (gameState.selectedIngredients.length === 1) {
                    objectText = gameState.selectedIngredients[0].name;
                } else {
                    const names = gameState.selectedIngredients.map(ing => ing.name);
                    objectText = names.slice(0, -1).join('ã€') + 'å’Œ' + names[names.length - 1];
                }
                
                const objectItem = createWordItem(objectText, 'object');
                elements.wordBank.insertBefore(objectItem, elements.wordBank.querySelector('[data-type="ba"]'));
            }
        }
        
        // æ¸²æŸ“å¥å­æ„å»ºåŒº
        function renderSentenceArea() {
            elements.sentenceArea.innerHTML = '';
            
            // æ¸…ç©ºå½“å‰å¥å­
            gameState.currentSentence = [];
            
            // æ·»åŠ å ä½ç¬¦
            const placeholders = ['ä¸»è¯­', 'æŠŠ', 'å®¾è¯­', 'åŠ¨è¯', 'å…¶ä»–æˆåˆ†'];
            placeholders.forEach((placeholder, index) => {
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'sentence-word placeholder';
                placeholderDiv.textContent = placeholder;
                placeholderDiv.dataset.index = index;
                
                // å…è®¸æ‹–æ”¾
                placeholderDiv.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    placeholderDiv.style.backgroundColor = '#f0f0f0';
                });
                
                placeholderDiv.addEventListener('dragleave', () => {
                    placeholderDiv.style.backgroundColor = '';
                });
                
                placeholderDiv.addEventListener('drop', (e) => {
                    e.preventDefault();
                    placeholderDiv.style.backgroundColor = '';
                    
                    try {
                        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                        addWordToSentence(data.text, data.type, parseInt(placeholderDiv.dataset.index));
                    } catch (err) {
                        console.error('æ‹–æ”¾æ•°æ®è§£æé”™è¯¯:', err);
                    }
                });
                
                // ç‚¹å‡»ç§»é™¤
                placeholderDiv.addEventListener('click', () => {
                    if (!placeholderDiv.classList.contains('placeholder')) {
                        removeWordFromSentence(parseInt(placeholderDiv.dataset.index));
                    }
                });
                
                elements.sentenceArea.appendChild(placeholderDiv);
            });
            
            // å¯ç”¨æ‹–æ”¾
            elements.sentenceArea.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            elements.sentenceArea.addEventListener('drop', (e) => {
                e.preventDefault();
                const rect = elements.sentenceArea.getBoundingClientRect();
                const x = e.clientX - rect.left;
                
                // è®¡ç®—æ”¾ç½®ä½ç½®
                const children = Array.from(elements.sentenceArea.children);
                let insertIndex = children.length;
                
                for (let i = 0; i < children.length; i++) {
                    const childRect = children[i].getBoundingClientRect();
                    const childCenter = childRect.left - rect.left + childRect.width / 2;
                    
                    if (x < childCenter) {
                        insertIndex = i;
                        break;
                    }
                }
                
                try {
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    addWordToSentence(data.text, data.type, insertIndex);
                } catch (err) {
                    console.error('æ‹–æ”¾æ•°æ®è§£æé”™è¯¯:', err);
                }
            });
        }
        
        // æ·»åŠ è¯è¯­åˆ°å¥å­
        function addWordToSentence(text, type, index = null) {
            // å¦‚æœæŒ‡å®šäº†ç´¢å¼•ï¼Œåœ¨è¯¥ä½ç½®æ’å…¥
            if (index !== null && index >= 0 && index <= gameState.currentSentence.length) {
                gameState.currentSentence.splice(index, 0, { text, type });
            } else {
                // å¦åˆ™æ·»åŠ åˆ°æœ«å°¾
                gameState.currentSentence.push({ text, type });
            }
            
            // æ›´æ–°å¥å­æ˜¾ç¤º
            updateSentenceDisplay();
        }
        
        // ä»å¥å­ä¸­ç§»é™¤è¯è¯­
        function removeWordFromSentence(index) {
            if (index >= 0 && index < gameState.currentSentence.length) {
                gameState.currentSentence.splice(index, 1);
                updateSentenceDisplay();
            }
        }
        
        // æ›´æ–°å¥å­æ˜¾ç¤º
        function updateSentenceDisplay() {
            // æ¸…ç©ºå¥å­åŒºåŸŸ
            elements.sentenceArea.innerHTML = '';
            
            if (gameState.currentSentence.length === 0) {
                // æ˜¾ç¤ºå ä½ç¬¦
                const placeholders = ['ä¸»è¯­', 'æŠŠ', 'å®¾è¯­', 'åŠ¨è¯', 'å…¶ä»–æˆåˆ†'];
                placeholders.forEach((placeholder, index) => {
                    const placeholderDiv = document.createElement('div');
                    placeholderDiv.className = 'sentence-word placeholder';
                    placeholderDiv.textContent = placeholder;
                    placeholderDiv.dataset.index = index;
                    
                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆä¸renderSentenceAreaä¸­ç›¸åŒï¼‰
                    setupPlaceholderEvents(placeholderDiv);
                    
                    elements.sentenceArea.appendChild(placeholderDiv);
                });
            } else {
                // æ˜¾ç¤ºå½“å‰å¥å­
                gameState.currentSentence.forEach((word, index) => {
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'sentence-word';
                    wordDiv.textContent = word.text;
                    wordDiv.dataset.index = index;
                    wordDiv.dataset.type = word.type;
                    
                    // ç‚¹å‡»ç§»é™¤
                    wordDiv.addEventListener('click', () => {
                        removeWordFromSentence(index);
                    });
                    
                    elements.sentenceArea.appendChild(wordDiv);
                });
                
                // åœ¨æœ«å°¾æ·»åŠ ä¸€ä¸ªé¢å¤–çš„å ä½ç¬¦
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'sentence-word placeholder';
                placeholderDiv.textContent = '+';
                placeholderDiv.dataset.index = gameState.currentSentence.length;
                setupPlaceholderEvents(placeholderDiv);
                elements.sentenceArea.appendChild(placeholderDiv);
            }
            
            // é‡æ–°å¯ç”¨æ‹–æ”¾
            elements.sentenceArea.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            elements.sentenceArea.addEventListener('drop', (e) => {
                e.preventDefault();
                const rect = elements.sentenceArea.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const children = Array.from(elements.sentenceArea.children);
                let insertIndex = children.length - 1; // æœ€åä¸€ä¸ªå ä½ç¬¦å‰
                
                for (let i = 0; i < children.length; i++) {
                    const childRect = children[i].getBoundingClientRect();
                    const childCenter = childRect.left - rect.left + childRect.width / 2;
                    
                    if (x < childCenter) {
                        insertIndex = i;
                        break;
                    }
                }
                
                try {
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    addWordToSentence(data.text, data.type, insertIndex);
                } catch (err) {
                    console.error('æ‹–æ”¾æ•°æ®è§£æé”™è¯¯:', err);
                }
            });
        }
        
        // è®¾ç½®å ä½ç¬¦äº‹ä»¶
        function setupPlaceholderEvents(element) {
            element.addEventListener('dragover', (e) => {
                e.preventDefault();
                element.style.backgroundColor = '#f0f0f0';
            });
            
            element.addEventListener('dragleave', () => {
                element.style.backgroundColor = '';
            });
            
            element.addEventListener('drop', (e) => {
                e.preventDefault();
                element.style.backgroundColor = '';
                
                try {
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    addWordToSentence(data.text, data.type, parseInt(element.dataset.index));
                } catch (err) {
                    console.error('æ‹–æ”¾æ•°æ®è§£æé”™è¯¯:', err);
                }
            });
        }
        
        // æ¸…ç©ºå¥å­
        function clearSentence() {
            gameState.currentSentence = [];
            updateSentenceDisplay();
            showFeedback('å¥å­å·²æ¸…ç©º', 'info', 'student');
        }
        
        // éªŒè¯å¥å­
        function validateSentence() {
            if (gameState.currentSentence.length === 0) {
                showFeedback('è¯·å…ˆæ„å»ºä¸€ä¸ªå¥å­', 'warning', 'student');
                return;
            }
            
            if (gameState.selectedIngredients.length === 0) {
                showFeedback('è¯·å…ˆé€‰æ‹©åŸæ–™', 'warning', 'student');
                return;
            }
            
            gameState.totalAttempts++;
            
            // æ„å»ºå¥å­æ–‡æœ¬
            const sentenceText = gameState.currentSentence.map(word => word.text).join('');
            
            // éªŒè¯å¥å­
            const validation = validateSentenceStructure(gameState.currentSentence);
            
            if (validation.isValid) {
                // å¥å­æ­£ç¡®
                gameState.correctCount++;
                showFeedback('âœ“ å¥å­æ­£ç¡®ï¼ç‚¹å‡»"æ·»åŠ åˆ°ç¢—ä¸­"æŒ‰é’®æ·»åŠ åŸæ–™', 'success', 'student');
                
                // å¯ç”¨æ·»åŠ æŒ‰é’®
                elements.addIngredientBtn.disabled = false;
                elements.addIngredientBtn.classList.add('pulse');
                
                // æ›´æ–°åˆ†æ•°
                gameState.score += 10;
                updateScoreDisplay();
                
                // ä¿å­˜æ­£ç¡®çš„å¥å­
                gameState.validatedSentence = {
                    text: sentenceText,
                    ingredients: [...gameState.selectedIngredients]
                };
            } else {
                // å¥å­æœ‰é”™è¯¯
                showFeedback(`å¥å­ä¸æ­£ç¡®ï¼š${validation.error}`, 'error', 'student');
                updateScoreDisplay();
            }
            
            // åŒæ­¥æ•°æ®
            syncStudentData();
        }
        
        // éªŒè¯å¥å­ç»“æ„
        function validateSentenceStructure(sentence) {
            // è½¬æ¢ä¸ºç±»å‹æ•°ç»„
            const types = sentence.map(word => word.type);
            const text = sentence.map(word => word.text).join('');
            
            // åŸºæœ¬æ£€æŸ¥
            if (types.length < 4) {
                return { isValid: false, error: 'å¥å­å¤ªçŸ­ï¼Œç¼ºå°‘å¿…è¦æˆåˆ†' };
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«"æŠŠ"
            if (!types.includes('ba')) {
                return { isValid: false, error: 'å¥å­ä¸­ç¼ºå°‘"æŠŠ"å­—' };
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸»è¯­
            if (!types.includes('subject')) {
                return { isValid: false, error: 'å¥å­ä¸­ç¼ºå°‘ä¸»è¯­' };
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«åŠ¨è¯
            if (!types.includes('verb')) {
                return { isValid: false, error: 'å¥å­ä¸­ç¼ºå°‘åŠ¨è¯' };
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å®¾è¯­ï¼ˆå¦‚æœæœ‰é€‰æ‹©åŸæ–™ï¼‰
            if (gameState.selectedIngredients.length > 0 && !types.includes('object')) {
                return { isValid: false, error: 'å¥å­ä¸­æ²¡æœ‰æåˆ°é€‰æ‹©çš„åŸæ–™' };
            }
            
            // æ£€æŸ¥"æŠŠ"çš„ä½ç½®æ˜¯å¦åˆç†
            const baIndex = types.indexOf('ba');
            const subjectIndex = types.indexOf('subject');
            
            if (baIndex <= subjectIndex) {
                return { isValid: false, error: '"æŠŠ"å­—åº”è¯¥åœ¨ä¸»è¯­åé¢' };
            }
            
            // æ£€æŸ¥å®¾è¯­æ˜¯å¦åœ¨"æŠŠ"åé¢
            if (types.includes('object')) {
                const objectIndex = types.indexOf('object');
                if (objectIndex <= baIndex) {
                    return { isValid: false, error: 'å®¾è¯­åº”è¯¥åœ¨"æŠŠ"å­—åé¢' };
                }
            }
            
            // æ£€æŸ¥åŠ¨è¯ä½ç½®
            const verbIndex = types.indexOf('verb');
            if (verbIndex <= baIndex) {
                return { isValid: false, error: 'åŠ¨è¯åº”è¯¥åœ¨"æŠŠ"å­—åé¢' };
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä½ç§»æˆåˆ†ï¼ˆä»‹è¯+åœ°ç‚¹æˆ–ç›´æ¥åœ°ç‚¹ï¼‰
            const hasPreposition = types.includes('preposition');
            const hasLocation = types.includes('location');
            
            if (!hasLocation) {
                return { isValid: false, error: 'ä½ç§»æŠŠå­—å¥éœ€è¦æŒ‡æ˜åœ°ç‚¹' };
            }
            
            // å¦‚æœå¥å­åŸºæœ¬æ­£ç¡®ï¼Œè¿›ä¸€æ­¥æ£€æŸ¥è¯­ä¹‰
            const locationIndex = types.indexOf('location');
            if (verbIndex >= locationIndex) {
                return { isValid: false, error: 'åœ°ç‚¹åº”è¯¥åœ¨åŠ¨è¯åé¢' };
            }
            
            // æ£€æŸ¥é€‰æ‹©çš„åŸæ–™æ˜¯å¦éƒ½åœ¨å¥å­ä¸­æåˆ°
            if (gameState.selectedIngredients.length > 0 && types.includes('object')) {
                const objectWord = sentence.find(word => word.type === 'object');
                const objectText = objectWord.text;
                
                for (const ingredient of gameState.selectedIngredients) {
                    if (!objectText.includes(ingredient.name)) {
                        return { isValid: false, error: `å¥å­ä¸­æ²¡æœ‰æåˆ°åŸæ–™"${ingredient.name}"` };
                    }
                }
            }
            
            return { isValid: true, error: null };
        }
        
        // æ·»åŠ åŸæ–™åˆ°ç¢—ä¸­
        function addIngredientsToBowl() {
            if (!gameState.validatedSentence) {
                showFeedback('è¯·å…ˆéªŒè¯å¥å­', 'warning', 'student');
                return;
            }
            
            // æ·»åŠ åŸæ–™åˆ°ç¢—ä¸­
            gameState.selectedIngredients.forEach(ingredient => {
                // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
                if (!gameState.addedIngredients.some(item => item.id === ingredient.id)) {
                    gameState.addedIngredients.push({
                        ...ingredient,
                        sentence: gameState.validatedSentence.text,
                        addedAt: new Date().toISOString()
                    });
                    
                    // åœ¨ç¢—ä¸­æ˜¾ç¤ºåŸæ–™
                    addIngredientToBowlVisual(ingredient);
                }
            });
            
            // æ¸…ç©ºé€‰æ‹©
            gameState.selectedIngredients = [];
            gameState.validatedSentence = null;
            
            // æ›´æ–°æ˜¾ç¤º
            updateSelectedIngredientsDisplay();
            updateWordBank();
            clearSentence();
            updateAddedIngredientsList();
            updateProgressDisplay();
            
            // ç¦ç”¨æ·»åŠ æŒ‰é’®
            elements.addIngredientBtn.disabled = true;
            elements.addIngredientBtn.classList.remove('pulse');
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showFeedback('åŸæ–™å·²æˆåŠŸæ·»åŠ åˆ°ç¢—ä¸­ï¼', 'success', 'student');
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if (gameState.addedIngredients.length >= ingredients.length) {
                showCompletionModal();
            }
            
            // åŒæ­¥æ•°æ®
            syncStudentData();
            
            // é‡æ–°æ¸²æŸ“åŸæ–™ï¼ˆæ›´æ–°å·²æ·»åŠ çŠ¶æ€ï¼‰
            renderIngredients();
        }
        
        // åœ¨ç¢—ä¸­æ˜¾ç¤ºåŸæ–™ï¼ˆè§†è§‰ï¼‰
        function addIngredientToBowlVisual(ingredient) {
            const ingredientInBowl = document.createElement('div');
            ingredientInBowl.className = 'ingredient-in-bowl';
            ingredientInBowl.textContent = ingredient.emoji;
            ingredientInBowl.title = ingredient.name;
            
            // éšæœºä½ç½®ï¼ˆé¿å…å®Œå…¨é‡å ï¼‰
            const size = 35 + Math.random() * 25;
            const x = 20 + Math.random() * 160;
            const y = 20 + Math.random() * 160;
            
            ingredientInBowl.style.width = `${size}px`;
            ingredientInBowl.style.height = `${size}px`;
            ingredientInBowl.style.left = `${x}px`;
            ingredientInBowl.style.top = `${y}px`;
            ingredientInBowl.style.fontSize = `${size * 0.7}px`;
            ingredientInBowl.style.lineHeight = `${size}px`;
            ingredientInBowl.style.backgroundColor = ingredient.color;
            ingredientInBowl.style.zIndex = gameState.addedIngredients.length;
            
            elements.bowl.appendChild(ingredientInBowl);
            
            // å½“ç¢—ä¸­æœ‰åŸæ–™æ—¶ï¼Œæ·»åŠ å¡«å……æ•ˆæœ
            if (gameState.addedIngredients.length > 0) {
                elements.bowl.classList.add('filled');
            }
            
            // æ›´æ–°ç»“æœæ–‡æœ¬
            updateResultText();
        }
        
        // æ›´æ–°ç»“æœæ–‡æœ¬
        function updateResultText() {
            const count = gameState.addedIngredients.length;
            const total = ingredients.length;
            
            if (count === 0) {
                elements.resultText.textContent = 'ç¢—æ˜¯ç©ºçš„ï¼Œå¼€å§‹æ·»åŠ åŸæ–™è°ƒé…é¥ºå­é¦…å§ï¼';
                return;
            }
            
            if (count < 3) {
                const ingredientNames = gameState.addedIngredients.map(item => item.name).join('ã€');
                elements.resultText.textContent = `å·²ç»å¼€å§‹è°ƒé…é¥ºå­é¦…ï¼æ·»åŠ äº†ï¼š${ingredientNames}ã€‚`;
                return;
            }
            
            if (count < total) {
                const ingredientNames = gameState.addedIngredients.map(item => item.name).join('ã€');
                elements.resultText.textContent = `é¥ºå­é¦…è¶Šæ¥è¶Šä¸°å¯Œäº†ï¼å·²ç»æ·»åŠ äº†ï¼š${ingredientNames}ã€‚`;
                return;
            }
            
            // æ‰€æœ‰åŸæ–™éƒ½æ·»åŠ äº†
            elements.resultText.innerHTML = `
                <strong>æ­å–œï¼é¥ºå­é¦…è°ƒé…å®Œæˆï¼</strong><br>
                ä½ è°ƒé…çš„é¥ºå­é¦…åŒ…å«ï¼š${gameState.addedIngredients.map(item => item.name).join('ã€')}ã€‚<br>
                <span style="color: var(--success-color);">ç°åœ¨å¯ä»¥å¼€å§‹åŒ…é¥ºå­äº†ï¼</span>
            `;
        }
        
        // æ›´æ–°å·²æ·»åŠ åŸæ–™åˆ—è¡¨
        function updateAddedIngredientsList() {
            if (gameState.addedIngredients.length === 0) {
                elements.addedIngredientsList.innerHTML = `
                    <p style="color: var(--text-light); text-align: center; padding: 20px;">
                        è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•åŸæ–™
                    </p>
                `;
                return;
            }
            
            let listHTML = '<ul style="margin: 0; padding: 0;">';
            gameState.addedIngredients.forEach((item, index) => {
                listHTML += `
                    <li style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; 
                         background-color: #f9f9f9; border-radius: 8px; border-left: 4px solid ${item.color};">
                        <div style="font-size: 1.5rem; margin-right: 15px;">${item.emoji}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${item.name} <span style="color: var(--text-light); font-size: 0.9em;">(${item.pinyin})</span></div>
                            <div style="color: var(--text-light); font-size: 0.9em;">${item.sentence}</div>
                        </div>
                        <div style="color: var(--text-light); font-size: 0.8em;">#${index + 1}</div>
                    </li>
                `;
            });
            listHTML += '</ul>';
            
            elements.addedIngredientsList.innerHTML = listHTML;
        }
        
        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgressDisplay() {
            const count = gameState.addedIngredients.length;
            const total = ingredients.length;
            const percentage = Math.min(100, (count / total) * 100);
            
            elements.progressText.textContent = `${count}/${total}`;
            elements.progressFill.style.width = `${percentage}%`;
        }
        
        // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
        function updateScoreDisplay() {
            elements.scoreValue.textContent = gameState.score;
            
            const accuracy = gameState.totalAttempts > 0 
                ? Math.round((gameState.correctCount / gameState.totalAttempts) * 100) 
                : 0;
            elements.accuracyValue.textContent = `${accuracy}%`;
            
            elements.attemptsValue.textContent = gameState.totalAttempts;
        }
        
        // æ˜¾ç¤ºè¯­æ³•æç¤º
        function showGrammarHint() {
            elements.grammarHintModal.style.display = 'flex';
        }
        
        // æ˜¾ç¤ºå®Œæˆæ¨¡æ€æ¡†
        function showCompletionModal() {
            // è®¡ç®—ç”¨æ—¶
            const timeUsed = Math.round((Date.now() - gameState.startTime) / 1000);
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            
            elements.finalScore.textContent = gameState.score;
            elements.finalAccuracy.textContent = `${Math.round((gameState.correctCount / gameState.totalAttempts) * 100)}%`;
            elements.finalTime.textContent = `${minutes > 0 ? `${minutes}åˆ†` : ''}${seconds}ç§’`;
            
            elements.successModal.style.display = 'flex';
            
            // åœæ­¢æ¸¸æˆ
            gameState.gameActive = false;
        }
        
        // æœ—è¯»å½“å‰å¥å­
        function speakCurrentSentence() {
            if (gameState.currentSentence.length === 0) {
                showFeedback('æ²¡æœ‰å¥å­å¯æœ—è¯»', 'warning', 'student');
                return;
            }
            
            const sentenceText = gameState.currentSentence.map(word => word.text).join('');
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(sentenceText);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
                
                showFeedback('æ­£åœ¨æœ—è¯»å¥å­...', 'info', 'student');
            } else {
                showFeedback('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»åŠŸèƒ½', 'error', 'student');
            }
        }
        
        // åˆ†äº«ç»“æœ
        function shareResults() {
            const resultText = `æˆ‘å®Œæˆäº†é¥ºå­é¦…è°ƒé…æ¸¸æˆï¼å¾—åˆ†ï¼š${gameState.score}ï¼Œä½¿ç”¨äº†æ‰€æœ‰8ç§åŸæ–™ï¼`;
            
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒWeb Share API
            if (navigator.share) {
                navigator.share({
                    title: 'é¥ºå­é¦…è°ƒé…æ¸¸æˆæˆç»©',
                    text: resultText,
                    url: window.location.href
                }).catch(err => {
                    console.log('åˆ†äº«å¤±è´¥:', err);
                    copyToClipboard(resultText);
                });
            } else {
                copyToClipboard(resultText);
            }
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showFeedback('æˆç»©å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success', 'student');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showFeedback('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error', 'student');
            });
        }
        
        // æ•™å¸ˆç«¯ï¼šåˆ›å»ºç­çº§
        function createClass() {
            const classCode = elements.teacherClassCodeInput.value.trim() || generateClassCode();
            
            if (!classCode) {
                showFeedback('è¯·è¾“å…¥ç­çº§ä»£ç ', 'error', 'teacher');
                return;
            }
            
            // æ£€æŸ¥ç­çº§æ˜¯å¦å·²å­˜åœ¨
            const existingClass = localStorage.getItem(`dumpling_class_${classCode}`);
            if (existingClass) {
                if (!confirm(`ç­çº§ä»£ç  "${classCode}" å·²å­˜åœ¨ï¼Œæ˜¯å¦åŠ è½½ç°æœ‰ç­çº§ï¼Ÿ`)) {
                    return;
                }
            }
            
            // åˆ›å»ºæ–°ç­çº§
            const classData = {
                code: classCode,
                name: `é¥ºå­è¯¾ ${new Date().toLocaleDateString()}`,
                created: new Date().toISOString(),
                teacher: 'è€å¸ˆ',
                students: {},
                settings: {
                    maxIngredients: 8,
                    timeLimit: null,
                    allowRetry: true
                }
            };
            
            localStorage.setItem(`dumpling_class_${classCode}`, JSON.stringify(classData));
            localStorage.setItem('teacherClassCode', classCode);
            
            // æ›´æ–°UI
            elements.teacherClassCodeInput.value = classCode;
            gameState.teacher.classCode = classCode;
            gameState.teacher.classData = classData;
            
            // æ˜¾ç¤ºç­çº§ä¿¡æ¯
            elements.classInfo.style.display = 'block';
            
            // åŠ è½½å­¦ç”Ÿæ•°æ®
            loadStudentData();
            
            showFeedback(`ç­çº§ "${classCode}" åˆ›å»ºæˆåŠŸï¼`, 'success', 'teacher');
        }
        
        // ç”Ÿæˆç­çº§ä»£ç 
        function generateClassCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // æ•™å¸ˆç«¯ï¼šåŠ è½½ç­çº§
        function loadClass() {
            const classCode = elements.teacherClassCodeInput.value.trim();
            
            if (!classCode) {
                showFeedback('è¯·è¾“å…¥ç­çº§ä»£ç ', 'error', 'teacher');
                return;
            }
            
            // åŠ è½½ç­çº§æ•°æ®
            const classData = localStorage.getItem(`dumpling_class_${classCode}`);
            if (!classData) {
                showFeedback(`ç­çº§ä»£ç  "${classCode}" ä¸å­˜åœ¨`, 'error', 'teacher');
                return;
            }
            
            // è§£æç­çº§æ•°æ®
            gameState.teacher.classCode = classCode;
            gameState.teacher.classData = JSON.parse(classData);
            
            // ä¿å­˜ç­çº§ä»£ç 
            localStorage.setItem('teacherClassCode', classCode);
            
            // æ›´æ–°UI
            elements.classInfo.style.display = 'block';
            
            // åŠ è½½å­¦ç”Ÿæ•°æ®
            loadStudentData();
            
            showFeedback(`ç­çº§ "${classCode}" åŠ è½½æˆåŠŸï¼`, 'success', 'teacher');
            
            // å¼€å§‹å®šæœŸåˆ·æ–°
            startTeacherRefresh();
        }
        
        // æ•™å¸ˆç«¯ï¼šåŠ è½½å­¦ç”Ÿæ•°æ®
        function loadStudentData() {
            if (!gameState.teacher.classCode) return;
            
            // é‡æ–°åŠ è½½ç­çº§æ•°æ®
            const classData = localStorage.getItem(`dumpling_class_${gameState.teacher.classCode}`);
            if (!classData) {
                elements.studentListContainer.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <p style="color: var(--danger-color);">ç­çº§æ•°æ®ä¸å­˜åœ¨æˆ–å·²åˆ é™¤</p>
                    </div>
                `;
                return;
            }
            
            gameState.teacher.classData = JSON.parse(classData);
            const students = gameState.teacher.classData.students;
            const studentKeys = Object.keys(students);
            
            // æ›´æ–°ç­çº§æ¦‚è§ˆ
            elements.totalStudents.textContent = studentKeys.length;
            
            let activeCount = 0;
            let completedCount = 0;
            let totalScore = 0;
            
            // è®¡ç®—æ´»è·ƒå’Œå®Œæˆçš„å­¦ç”Ÿ
            studentKeys.forEach(key => {
                const student = students[key];
                totalScore += student.score || 0;
                
                // å¦‚æœå­¦ç”Ÿæœ€è¿‘5åˆ†é’Ÿå†…æœ‰æ´»åŠ¨ï¼Œè§†ä¸ºæ´»è·ƒ
                const lastActive = student.lastUpdated ? new Date(student.lastUpdated) : null;
                const now = new Date();
                const isActive = lastActive && (now - lastActive) < 5 * 60 * 1000;
                
                if (isActive) activeCount++;
                
                // å¦‚æœå­¦ç”Ÿå®Œæˆäº†æ‰€æœ‰åŸæ–™ï¼Œè§†ä¸ºå®Œæˆ
                if (student.progress >= 8) completedCount++;
            });
            
            elements.activeStudents.textContent = activeCount;
            elements.completedStudents.textContent = completedCount;
            elements.averageScore.textContent = studentKeys.length > 0 
                ? Math.round(totalScore / studentKeys.length) 
                : 0;
            
            // æ›´æ–°å­¦ç”Ÿåˆ—è¡¨
            updateStudentList(students);
        }
        
        // æ›´æ–°å­¦ç”Ÿåˆ—è¡¨
        function updateStudentList(students) {
            elements.studentListContainer.innerHTML = '';
            
            const studentKeys = Object.keys(students);
            
            if (studentKeys.length === 0) {
                elements.studentListContainer.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <p style="color: var(--text-light);">è¿˜æ²¡æœ‰å­¦ç”ŸåŠ å…¥ç­çº§</p>
                        <p style="color: var(--text-light); font-size: 0.9em; margin-top: 10px;">
                            å°†ç­çº§ä»£ç å‘Šè¯‰å­¦ç”Ÿï¼Œè®©ä»–ä»¬åŠ å…¥å§ï¼
                        </p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æœ€åæ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            studentKeys.sort((a, b) => {
                const timeA = students[a].lastUpdated ? new Date(students[a].lastUpdated) : new Date(0);
                const timeB = students[b].lastUpdated ? new Date(students[b].lastUpdated) : new Date(0);
                return timeB - timeA;
            });
            
            // åˆ›å»ºå­¦ç”Ÿå¡ç‰‡
            studentKeys.forEach(key => {
                const student = students[key];
                const lastActive = student.lastUpdated ? new Date(student.lastUpdated) : null;
                const now = new Date();
                const isActive = lastActive && (now - lastActive) < 5 * 60 * 1000;
                const isCompleted = student.progress >= 8;
                
                let statusClass = 'inactive';
                let statusText = 'ç¦»çº¿';
                
                if (isCompleted) {
                    statusClass = 'completed';
                    statusText = 'å·²å®Œæˆ';
                } else if (isActive) {
                    statusClass = 'active';
                    statusText = 'æ´»è·ƒ';
                }
                
                const progressPercent = Math.round((student.progress || 0) / 8 * 100);
                
                // åˆ›å»ºå­¦ç”Ÿå¡ç‰‡
                const studentCard = document.createElement('div');
                studentCard.className = `student-card ${statusClass}`;
                
                studentCard.innerHTML = `
                    <div class="student-header">
                        <div class="student-name">
                            <span class="icon">ğŸ‘¤</span> ${student.name}
                            ${student.id ? `<span style="color: var(--text-light); font-size: 0.9em;">(${student.id})</span>` : ''}
                        </div>
                        <div class="student-status status-${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                    
                    <div class="student-progress-bar">
                        <div class="student-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    <div class="student-details">
                        <div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--primary-color);">
                                ${student.score || 0}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">å¾—åˆ†</div>
                        </div>
                        <div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--info-color);">
                                ${student.progress || 0}/8
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">åŸæ–™</div>
                        </div>
                        <div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--success-color);">
                                ${student.correctCount || 0}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">æ­£ç¡®å¥å­</div>
                        </div>
                    </div>
                    
                    ${student.addedIngredients && student.addedIngredients.length > 0 ? `
                        <div class="student-ingredients">
                            <strong>æœ€è¿‘æ·»åŠ çš„åŸæ–™ï¼š</strong>
                            <ul>
                                ${student.addedIngredients.slice(-3).map(item => `
                                    <li>${item.emoji} ${item.name}: "${item.sentence || 'æ— å¥å­'}"</li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="timestamp" style="margin-top: 10px;">
                        æœ€åæ›´æ–°: ${lastActive ? lastActive.toLocaleTimeString() : 'ä»æœª'}
                    </div>
                `;
                
                elements.studentListContainer.appendChild(studentCard);
            });
        }
        
        // æŒ‰å¾—åˆ†æ’åºå­¦ç”Ÿ
        function sortStudentsByScore() {
            if (!gameState.teacher.classData) return;
            
            const students = gameState.teacher.classData.students;
            const studentKeys = Object.keys(students);
            
            // æŒ‰å¾—åˆ†æ’åºï¼ˆé™åºï¼‰
            studentKeys.sort((a, b) => {
                const scoreA = students[a].score || 0;
                const scoreB = students[b].score || 0;
                return scoreB - scoreA;
            });
            
            // æ›´æ–°æ˜¾ç¤º
            const sortedStudents = {};
            studentKeys.forEach(key => {
                sortedStudents[key] = students[key];
            });
            
            updateStudentList(sortedStudents);
            showFeedback('å·²æŒ‰å¾—åˆ†æ’åº', 'info', 'teacher');
        }
        
        // å¯¼å‡ºç­çº§æ•°æ®
        function exportClassData() {
            if (!gameState.teacher.classData) {
                showFeedback('è¯·å…ˆåŠ è½½ç­çº§', 'error', 'teacher');
                return;
            }
            
            const dataStr = JSON.stringify(gameState.teacher.classData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `é¥ºå­è¯¾_${gameState.teacher.classCode}_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showFeedback('ç­çº§æ•°æ®å·²å¯¼å‡º', 'success', 'teacher');
        }
        
        // åŒæ­¥å­¦ç”Ÿæ•°æ®åˆ°ç­çº§
        function syncStudentData() {
            if (!gameState.student.connected || !gameState.student.classCode) return;
            
            // åŠ è½½ç­çº§æ•°æ®
            const classData = localStorage.getItem(`dumpling_class_${gameState.student.classCode}`);
            if (!classData) return;
            
            const classObj = JSON.parse(classData);
            
            // æ›´æ–°å­¦ç”Ÿæ•°æ®
            classObj.students[gameState.student.name] = {
                name: gameState.student.name,
                id: gameState.student.id,
                score: gameState.score,
                correctCount: gameState.correctCount,
                totalAttempts: gameState.totalAttempts,
                addedIngredients: [...gameState.addedIngredients],
                progress: gameState.addedIngredients.length,
                lastUpdated: new Date().toISOString()
            };
            
            // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
            localStorage.setItem(`dumpling_class_${gameState.student.classCode}`, JSON.stringify(classObj));
        }
        
        // å¼€å§‹æ•°æ®åŒæ­¥
        function startDataSync() {
            // æ¯10ç§’åŒæ­¥ä¸€æ¬¡æ•°æ®
            setInterval(() => {
                if (gameState.student.connected && gameState.gameActive) {
                    syncStudentData();
                }
            }, 10000);
        }
        
        // å¼€å§‹æ•™å¸ˆç«¯åˆ·æ–°
        function startTeacherRefresh() {
            // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡å­¦ç”Ÿæ•°æ®
            setInterval(() => {
                if (elements.teacherView.style.display !== 'none' && gameState.teacher.classCode) {
                    loadStudentData();
                }
            }, 5000);
        }
        
        // æ£€æŸ¥ç°æœ‰ä¼šè¯
        function checkExistingSession() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„å­¦ç”Ÿä¿¡æ¯
            const savedStudent = localStorage.getItem('studentInfo');
            if (savedStudent) {
                try {
                    const studentInfo = JSON.parse(savedStudent);
                    
                    // è‡ªåŠ¨å¡«å……è¡¨å•
                    elements.studentNameInput.value = studentInfo.name || '';
                    elements.classCodeInput.value = studentInfo.classCode || '';
                    elements.studentIdInput.value = studentInfo.id || '';
                    
                    // æ£€æŸ¥ç­çº§æ˜¯å¦ä»ç„¶å­˜åœ¨
                    const classData = localStorage.getItem(`dumpling_class_${studentInfo.classCode}`);
                    if (classData) {
                        showFeedback('æ£€æµ‹åˆ°ä¹‹å‰çš„ä¼šè¯ï¼Œç‚¹å‡»"åŠ å…¥ç­çº§"ç»§ç»­æ¸¸æˆ', 'info', 'student');
                    }
                } catch (err) {
                    console.error('è§£æä¿å­˜çš„å­¦ç”Ÿä¿¡æ¯å¤±è´¥:', err);
                }
            }
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus() {
            // æ¨¡æ‹Ÿéšæœºçš„è¿æ¥çŠ¶æ€å˜åŒ–ï¼ˆå®é™…åº”ç”¨ä¸­åº”æ£€æŸ¥çœŸå®è¿æ¥ï¼‰
            const statuses = ['connected', 'disconnected', 'connecting'];
            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ£€æŸ¥çœŸå®çš„ç½‘ç»œè¿æ¥çŠ¶æ€
            // æš‚æ—¶ä½¿ç”¨éšæœºçŠ¶æ€æ¥æ¼”ç¤ºUIå˜åŒ–
            elements.globalConnectionStatus.className = `connection-status status-${randomStatus}`;
            elements.globalConnectionStatus.innerHTML = `
                <span class="icon">${randomStatus === 'connected' ? 'ğŸ”—' : randomStatus === 'disconnected' ? 'ğŸ”Œ' : 'ğŸ”„'}</span>
                ${randomStatus === 'connected' ? 'å·²è¿æ¥' : randomStatus === 'disconnected' ? 'å·²æ–­å¼€' : 'è¿æ¥ä¸­'}
            `;
        }
        
        // æ˜¾ç¤ºåé¦ˆæ¶ˆæ¯
        function showFeedback(message, type, role = 'global') {
            let feedbackElement;
            
            if (role === 'student') {
                feedbackElement = elements.gameFeedback;
                feedbackElement.style.display = 'block';
            } else if (role === 'teacher') {
                // æ•™å¸ˆç«¯ä½¿ç”¨alertç®€åŒ–
                alert(`${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'} ${message}`);
                return;
            } else {
                // å…¨å±€åé¦ˆæš‚æ—¶ä¸å®ç°
                return;
            }
            
            feedbackElement.textContent = message;
            feedbackElement.className = `feedback ${type}`;
            feedbackElement.innerHTML = `
                <span class="icon">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}</span>
                ${message}
            `;
            
            // 3ç§’åéšè—
            setTimeout(() => {
                feedbackElement.style.display = 'none';
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>